<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeit-Sch√§tz-Challenge - Gruppen-Modus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .timer-display {
            font-variant-numeric: tabular-nums;
        }
        .ranking-transition {
            transition: all 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Zeit-Sch√§tz-<span class="text-blue-600">Challenge</span></h1>
            <p class="text-slate-600 mt-2">Punkte-System: 1. Platz (10 Pkt) | 2. Platz (5 Pkt) | 3. Platz (1 Pkt)</p>
        </header>

        <!-- Login Section -->
        <div id="loginSection" class="glass-card rounded-2xl p-8 max-w-md mx-auto mb-10">
            <h2 class="text-xl font-semibold mb-4 text-center">Admin Login</h2>
            <div class="space-y-4">
                <input type="password" id="adminPassword" placeholder="Passwort (Standard: admin123)" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Anmelden</button>
            </div>
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden text-center">Falsches Passwort!</p>
        </div>

        <!-- Main Admin Panel -->
        <div id="adminPanel" class="hidden space-y-8">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Spalte 1: Stoppuhr & Eingabe -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="glass-card rounded-2xl p-6 flex flex-col items-center">
                        <div id="timer" class="timer-display text-5xl font-bold text-slate-800 mb-6">00:00.00</div>
                        <div class="flex space-x-2">
                            <button id="startBtn" onclick="toggleTimer()" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-full font-semibold transition">Start</button>
                            <button id="resetBtn" onclick="resetTimer()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-5 py-2 rounded-full font-semibold transition">Reset</button>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-slate-800">Aktuelle Gruppe</h2>
                            <span id="groupStatus" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold">0/3 Teilnehmer</span>
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="participantName" placeholder="Name" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="number" id="guessedTime" placeholder="Sch√§tzung (Sek.)" step="0.1" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="saveResult()" id="saveBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50" disabled>Ergebnis hinzuf√ºgen</button>
                        </div>
                        <div id="groupFullMsg" class="mt-4 hidden">
                            <button onclick="finalizeGroup()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Punkte vergeben & N√§chste Gruppe</button>
                        </div>
                    </div>
                </div>

                <!-- Spalte 2: Aktuelle Runde (Zwischenstand) -->
                <div class="lg:col-span-1">
                    <div class="glass-card rounded-2xl h-full overflow-hidden flex flex-col">
                        <div class="bg-slate-700 p-4">
                            <h2 class="text-white font-bold">Runden-Details</h2>
                        </div>
                        <div id="currentGroupList" class="p-4 space-y-3 flex-grow">
                            <p class="text-slate-400 text-center py-10">Warte auf Teilnehmer...</p>
                        </div>
                    </div>
                </div>

                <!-- Spalte 3: Gesamtrangliste (Punkte) -->
                <div class="lg:col-span-1">
                    <div class="glass-card rounded-2xl h-full overflow-hidden flex flex-col border-2 border-blue-200">
                        <div class="bg-blue-600 p-4">
                            <h2 class="text-white font-bold text-center">üèÜ HALL OF FAME (Punkte)</h2>
                        </div>
                        <div class="overflow-y-auto max-h-[500px]">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-xs font-bold text-slate-500 uppercase">Name</th>
                                        <th class="px-4 py-2 text-xs font-bold text-slate-500 uppercase text-right">Punkte</th>
                                    </tr>
                                </thead>
                                <tbody id="hallOfFameBody" class="divide-y divide-slate-100">
                                    <!-- Punkte werden hier angezeigt -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <div class="text-center pt-8">
                <button onclick="logout()" class="text-slate-500 hover:text-red-500 text-sm underline">Sitzung beenden</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition duration-300 z-50">
        Ergebnis gespeichert!
    </div>

    <script>
        // State Management
        let startTime;
        let elapsedTime = 0;
        let timerInterval;
        let isRunning = false;
        
        // Data Storage
        let currentGroupResults = [];
        let globalPoints = {}; // { "Name": TotalPoints }

        const PASSWORD = "admin123";

        function checkLogin() {
            const pass = document.getElementById('adminPassword').value;
            if (pass === PASSWORD) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadFromStorage();
                renderLeaderboards();
            } else {
                const err = document.getElementById('loginError');
                err.classList.remove('hidden');
                setTimeout(() => err.classList.add('hidden'), 3000);
            }
        }

        function logout() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
        }

        // Timer
        function toggleTimer() {
            const btn = document.getElementById('startBtn');
            const saveBtn = document.getElementById('saveBtn');

            if (!isRunning) {
                startTime = Date.now() - elapsedTime;
                timerInterval = setInterval(updateDisplay, 10);
                isRunning = true;
                btn.textContent = 'Stopp';
                btn.classList.replace('bg-green-500', 'bg-red-500');
                saveBtn.disabled = true;
            } else {
                clearInterval(timerInterval);
                isRunning = false;
                btn.textContent = 'Start';
                btn.classList.replace('bg-red-500', 'bg-green-500');
                if (currentGroupResults.length < 3) {
                    saveBtn.disabled = false;
                }
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            elapsedTime = 0;
            updateDisplay();
            document.getElementById('startBtn').textContent = 'Start';
            document.getElementById('startBtn').classList.remove('bg-red-500');
            document.getElementById('startBtn').classList.add('bg-green-500');
            document.getElementById('saveBtn').disabled = true;
        }

        function updateDisplay() {
            if (isRunning) elapsedTime = Date.now() - startTime;
            const minutes = Math.floor(elapsedTime / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            const ms = Math.floor((elapsedTime % 1000) / 10);
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        // Logic for Results
        function saveResult() {
            const name = document.getElementById('participantName').value.trim();
            const guessed = parseFloat(document.getElementById('guessedTime').value);
            
            if (!name || isNaN(guessed)) {
                showToast("Name und Sch√§tzung fehlen!");
                return;
            }

            if (currentGroupResults.length >= 3) {
                showToast("Gruppe ist bereits voll!");
                return;
            }

            const actualSec = elapsedTime / 1000;
            const diff = Math.abs(actualSec - guessed);

            currentGroupResults.push({
                name,
                actual: actualSec.toFixed(2),
                guessed: guessed.toFixed(2),
                diff: diff.toFixed(2),
                rawDiff: diff
            });

            // UI Updates
            updateGroupUI();
            resetTimer();
            document.getElementById('participantName').value = '';
            document.getElementById('guessedTime').value = '';
            showToast(`${name} hinzugef√ºgt`);

            if (currentGroupResults.length === 3) {
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('groupFullMsg').classList.remove('hidden');
            }
        }

        function updateGroupUI() {
            const list = document.getElementById('currentGroupList');
            const status = document.getElementById('groupStatus');
            status.textContent = `${currentGroupResults.length}/3 Teilnehmer`;

            if (currentGroupResults.length === 0) {
                list.innerHTML = `<p class="text-slate-400 text-center py-10">Warte auf Teilnehmer...</p>`;
                return;
            }

            // Sort current group to show who is currently winning
            const sorted = [...currentGroupResults].sort((a, b) => a.rawDiff - b.rawDiff);
            
            list.innerHTML = sorted.map((res, i) => `
                <div class="p-3 bg-white rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-slate-800">${res.name}</div>
                        <div class="text-xs text-slate-500">Ist: ${res.actual}s | Sch√§tzung: ${res.guessed}s</div>
                    </div>
                    <div class="text-right">
                        <div class="text-blue-600 font-bold">¬±${res.diff}s</div>
                        <div class="text-[10px] text-slate-400">Rang ${i+1}</div>
                    </div>
                </div>
            `).join('');
        }

        function finalizeGroup() {
            // Sort by difference
            currentGroupResults.sort((a, b) => a.rawDiff - b.rawDiff);

            // Assign Points
            // 1. Platz: 10, 2. Platz: 5, 3. Platz: 1
            const pointsMapping = [10, 5, 1];
            
            currentGroupResults.forEach((res, index) => {
                const pts = pointsMapping[index] || 0;
                globalPoints[res.name] = (globalPoints[res.name] || 0) + pts;
            });

            saveToStorage();
            renderLeaderboards();
            
            // Reset for next group
            currentGroupResults = [];
            updateGroupUI();
            document.getElementById('groupFullMsg').classList.add('hidden');
            showToast("Punkte wurden der Hall of Fame gutgeschrieben!");
        }

        function renderLeaderboards() {
            const body = document.getElementById('hallOfFameBody');
            body.innerHTML = '';

            // Convert object to array and sort by points descending
            const sortedNames = Object.entries(globalPoints)
                .sort(([, a], [, b]) => b - a);

            if (sortedNames.length === 0) {
                body.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic">Noch keine Punkte vergeben</td></tr>`;
                return;
            }

            sortedNames.forEach(([name, pts]) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-blue-50 transition";
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-semibold text-slate-800">${name}</td>
                    <td class="px-4 py-3 text-sm font-bold text-blue-700 text-right">${pts} Pkt</td>
                `;
                body.appendChild(row);
            });
        }

        // Storage Persistence
        function saveToStorage() {
            localStorage.setItem('challenge_points', JSON.stringify(globalPoints));
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('challenge_points');
            if (stored) {
                globalPoints = JSON.parse(stored);
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-20'), 2500);
        }
    </script>
</body>
</html>
